#!/bin/bash
# Post-installation script for rfc7030-est-client

set -e

# Detect OS and architecture
detect_binary() {
    if [ -f /etc/os-release ]; then
        . /etc/os-release
        case "$ID" in
            debian)
                case "$VERSION_ID" in
                    "11") echo "rfc7030-est-client-debian11" ;;
                    "12") echo "rfc7030-est-client-debian12" ;;
                    *) echo "rfc7030-est-client-debian12" ;; # Default to latest
                esac
                ;;
            ubuntu)
                case "$VERSION_ID" in
                    "20.04") echo "rfc7030-est-client-ubuntu2004" ;;
                    "22.04") echo "rfc7030-est-client-ubuntu2204" ;;
                    *) echo "rfc7030-est-client-ubuntu2204" ;; # Default to latest
                esac
                ;;
            *)
                # Fallback: try to detect based on available binaries
                if [ -f /usr/lib/rfc7030-est-client/rfc7030-est-client-debian12 ]; then
                    echo "rfc7030-est-client-debian12"
                elif [ -f /usr/lib/rfc7030-est-client/rfc7030-est-client-ubuntu2204 ]; then
                    echo "rfc7030-est-client-ubuntu2204"
                else
                    echo "rfc7030-est-client-debian12" # Default fallback
                fi
                ;;
        esac
    else
        echo "rfc7030-est-client-debian12" # Default fallback
    fi
}

# Create symlink for easy access
BINARY_NAME=$(detect_binary)
if [ ! -L /usr/bin/rfc7030-est-client ]; then
    ln -sf /usr/lib/rfc7030-est-client/${BINARY_NAME} /usr/bin/rfc7030-est-client
    echo "Created symlink: /usr/bin/rfc7030-est-client -> /usr/lib/rfc7030-est-client/${BINARY_NAME}"
fi

# Set executable permissions for all binaries
chmod +x /usr/lib/rfc7030-est-client/rfc7030-est-client-*

echo "rfc7030-est-client installed successfully"
echo "Using binary: ${BINARY_NAME}"
echo "You can now use 'rfc7030-est-client' command"
